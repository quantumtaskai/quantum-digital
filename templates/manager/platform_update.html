{% extends 'manager/base.html' %}

{% block page_title %}Platform Progress Update{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'manager:dashboard' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>
        Back to Dashboard
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="brand-card">
            <h4 class="mb-4">
                <i class="fas fa-chart-line me-2"></i>
                Quick Platform Progress Update
            </h4>
            
            <!-- Brand Selection -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="brandSelect" class="form-label"><strong>Select Brand:</strong></label>
                    <select class="form-select" id="brandSelect" onchange="loadBrandPlatforms()">
                        <option value="">Choose a brand...</option>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}">{{ brand.brand_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="platformSelect" class="form-label"><strong>Select Platform:</strong></label>
                    <select class="form-select" id="platformSelect" onchange="loadPlatformData()" disabled>
                        <option value="">Choose a platform...</option>
                    </select>
                </div>
            </div>
            
            <!-- Platform Update Form -->
            <div id="updateSection" style="display: none;">
                <form id="updateForm">
                    {% csrf_token %}
                    <input type="hidden" id="platformId" name="platform_id">
                    
                    <div class="row">
                        <!-- Progress Numbers -->
                        <div class="col-md-8">
                            <h5 class="mb-3" id="platformTitle">Platform Progress</h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="committed" class="form-label">Committed</label>
                                    <input type="number" class="form-control" id="committed" name="committed" min="0" onchange="updateProgress()">
                                    <div class="form-text">Total content promised to client</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="drafted" class="form-label">Drafted</label>
                                    <input type="number" class="form-control" id="drafted" name="drafted" min="0" onchange="updateProgress()">
                                    <div class="form-text">Content currently drafted</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="published" class="form-label">Published</label>
                                    <input type="number" class="form-control" id="published" name="published" min="0" onchange="updateProgress()">
                                    <div class="form-text">Content completed and published</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="platformLink" class="form-label">Platform Link</label>
                                    <input type="url" class="form-control" id="platformLink" name="platform_link" placeholder="https://">
                                    <div class="form-text">Direct link to social media profile</div>
                                    <div id="platformLinkDisplay" style="display: none;" class="mt-2">
                                        <a href="#" id="platformLinkUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-external-link-alt me-1"></i>
                                            Visit Platform
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress Bars -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small><strong>Draft Progress:</strong></small>
                                    <small id="draftPercentage">0%</small>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-warning" id="draftProgressBar" style="width: 0%;"></div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small><strong>Completion Progress:</strong></small>
                                    <small id="completionPercentage">0%</small>
                                </div>
                                <div class="progress mb-3" style="height: 8px;">
                                    <div class="progress-bar bg-success" id="completionProgressBar" style="width: 0%;"></div>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Internal notes for this platform"></textarea>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mb-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    Update Progress
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo me-2"></i>
                                    Reset
                                </button>
                            </div>
                        </div>
                        
                        <!-- Platform Status -->
                        <div class="col-md-4">
                            <h5 class="mb-3">Platform Status</h5>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span><strong>Visible:</strong></span>
                                    <span class="badge" id="visibilityBadge">-</span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span><strong>Active:</strong></span>
                                    <span class="badge" id="activeBadge">-</span>
                                </div>
                            </div>
                            
                            <!-- Content Links -->
                            <h6 class="mt-4 mb-3">Content Links</h6>
                            <div id="contentLinks">
                                <!-- Links will be loaded here -->
                            </div>
                            
                            <!-- Add New Link -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="showAddLinkForm()">
                                    <i class="fas fa-plus me-1"></i>
                                    Add Link
                                </button>
                            </div>
                            
                            <!-- Add Link Form (hidden by default) -->
                            <div id="addLinkForm" style="display: none;" class="mt-3 p-3 border rounded bg-light">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" id="linkTitle" placeholder="Link title">
                                </div>
                                <div class="mb-2">
                                    <input type="url" class="form-control form-control-sm" id="linkUrl" placeholder="https://">
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addContentLink()">
                                        <i class="fas fa-save"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="hideAddLinkForm()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Select a brand and platform to start updating</h5>
                <p class="text-muted">Choose a brand from the dropdown above to see available platforms</p>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1050">
    <div id="alertContainer"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF Token for AJAX requests
function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) {
        return token.value;
    }
    // Fallback: get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

// Global variables
let currentPlatformData = null;

// Load platforms for selected brand
async function loadBrandPlatforms() {
    const brandId = document.getElementById('brandSelect').value;
    const platformSelect = document.getElementById('platformSelect');
    
    // Reset platform dropdown
    platformSelect.innerHTML = '<option value="">Choose a platform...</option>';
    platformSelect.disabled = true;
    
    // Hide update section
    document.getElementById('updateSection').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
    
    if (!brandId) return;
    
    try {
        const response = await fetch(`/manager/brand/${brandId}/platforms/`);
        const data = await response.json();
        
        if (data.success && data.platforms.length > 0) {
            data.platforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform.id;
                option.textContent = platform.platform_display;
                platformSelect.appendChild(option);
            });
            platformSelect.disabled = false;
        } else {
            showAlert('No platforms found for this brand', 'warning');
        }
    } catch (error) {
        console.error('Error loading platforms:', error);
        showAlert('Error loading platforms', 'danger');
    }
}

// Load data for selected platform
async function loadPlatformData() {
    const platformSelect = document.getElementById('platformSelect');
    const selectedOption = platformSelect.options[platformSelect.selectedIndex];
    
    if (!selectedOption.value) {
        document.getElementById('updateSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    
    // Get platform data from the previous AJAX call
    const brandId = document.getElementById('brandSelect').value;
    
    try {
        const response = await fetch(`/manager/brand/${brandId}/platforms/`);
        const data = await response.json();
        
        if (data.success) {
            const platform = data.platforms.find(p => p.id == selectedOption.value);
            if (platform) {
                currentPlatformData = platform;
                populateForm(platform);
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('updateSection').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Error loading platform data:', error);
        showAlert('Error loading platform data', 'danger');
    }
}

// Populate form with platform data
function populateForm(platform) {
    document.getElementById('platformId').value = platform.id;
    document.getElementById('platformTitle').textContent = platform.platform_display + ' Progress';
    document.getElementById('committed').value = platform.committed;
    document.getElementById('drafted').value = platform.drafted;
    document.getElementById('published').value = platform.published;
    document.getElementById('notes').value = platform.notes;
    
    // Load platform link (look for "Platform Profile" in content links)
    const platformProfileLink = platform.content_links.find(link => link.title === 'Platform Profile');
    if (platformProfileLink) {
        document.getElementById('platformLink').value = platformProfileLink.url;
        updatePlatformLinkDisplay(platformProfileLink.url);
    } else {
        document.getElementById('platformLink').value = '';
        updatePlatformLinkDisplay('');
    }
    
    // Update status badges
    const visibilityBadge = document.getElementById('visibilityBadge');
    visibilityBadge.textContent = platform.is_visible ? 'Visible' : 'Hidden';
    visibilityBadge.className = platform.is_visible ? 'badge bg-success' : 'badge bg-secondary';
    
    const activeBadge = document.getElementById('activeBadge');
    activeBadge.textContent = platform.is_active ? 'Active' : 'Inactive';
    activeBadge.className = platform.is_active ? 'badge bg-success' : 'badge bg-danger';
    
    // Load content links (excluding platform profile link)
    const otherLinks = platform.content_links.filter(link => link.title !== 'Platform Profile');
    loadContentLinks(otherLinks);
    
    // Update progress bars
    updateProgress();
}

// Load content links
function loadContentLinks(links) {
    const container = document.getElementById('contentLinks');
    container.innerHTML = '';
    
    if (links.length === 0) {
        container.innerHTML = '<small class="text-muted">No content links added</small>';
        return;
    }
    
    links.forEach(link => {
        const linkDiv = document.createElement('div');
        linkDiv.className = 'mb-2 p-2 border rounded bg-white';
        linkDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small><strong>${link.title}</strong></small><br>
                    <a href="${link.url}" target="_blank" class="small text-decoration-none">
                        <i class="fas fa-external-link-alt me-1"></i>
                        ${link.url.length > 30 ? link.url.substring(0, 30) + '...' : link.url}
                    </a>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteContentLink(${link.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(linkDiv);
    });
}

// Update progress bars
function updateProgress() {
    const committed = parseInt(document.getElementById('committed').value) || 0;
    const drafted = parseInt(document.getElementById('drafted').value) || 0;
    const published = parseInt(document.getElementById('published').value) || 0;
    
    // Calculate percentages
    const draftPercentage = committed > 0 ? Math.round((drafted / committed) * 100) : 0;
    const completionPercentage = committed > 0 ? Math.round((published / committed) * 100) : 0;
    
    // Update progress bars
    document.getElementById('draftPercentage').textContent = draftPercentage + '%';
    document.getElementById('draftProgressBar').style.width = draftPercentage + '%';
    document.getElementById('completionPercentage').textContent = completionPercentage + '%';
    document.getElementById('completionProgressBar').style.width = completionPercentage + '%';
}

// Update platform link display
function updatePlatformLinkDisplay(url) {
    const display = document.getElementById('platformLinkDisplay');
    const linkElement = document.getElementById('platformLinkUrl');
    
    if (url && url.trim()) {
        linkElement.href = url;
        display.style.display = 'block';
    } else {
        display.style.display = 'none';
    }
}

// Add event listener for platform link input
document.addEventListener('DOMContentLoaded', function() {
    const platformLinkInput = document.getElementById('platformLink');
    if (platformLinkInput) {
        platformLinkInput.addEventListener('input', function() {
            updatePlatformLinkDisplay(this.value);
        });
    }
});

// Handle form submission
document.getElementById('updateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/manager/platform/update-progress/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            // Update progress bars with server-calculated values
            document.getElementById('draftPercentage').textContent = data.draft_percentage + '%';
            document.getElementById('draftProgressBar').style.width = data.draft_percentage + '%';
            document.getElementById('completionPercentage').textContent = data.completion_percentage + '%';
            document.getElementById('completionProgressBar').style.width = data.completion_percentage + '%';
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        console.error('Error updating progress:', error);
        showAlert('Error updating progress', 'danger');
    }
});

// Show/hide add link form
function showAddLinkForm() {
    document.getElementById('addLinkForm').style.display = 'block';
    document.getElementById('linkTitle').focus();
}

function hideAddLinkForm() {
    document.getElementById('addLinkForm').style.display = 'none';
    document.getElementById('linkTitle').value = '';
    document.getElementById('linkUrl').value = '';
}

// Add content link
async function addContentLink() {
    const platformId = document.getElementById('platformId').value;
    const title = document.getElementById('linkTitle').value.trim();
    const url = document.getElementById('linkUrl').value.trim();
    
    if (!title || !url) {
        showAlert('Please enter both title and URL', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('platform_id', platformId);
    formData.append('title', title);
    formData.append('url', url);
    
    try {
        const response = await fetch('/manager/platform/add-content-link/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            hideAddLinkForm();
            // Reload platform data to show new link
            loadPlatformData();
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        console.error('Error adding content link:', error);
        showAlert('Error adding content link', 'danger');
    }
}

// Delete content link
async function deleteContentLink(linkId) {
    if (!confirm('Are you sure you want to delete this content link?')) {
        return;
    }
    
    try {
        const response = await fetch(`/manager/content-link/${linkId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            // Reload platform data to remove deleted link
            loadPlatformData();
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        console.error('Error deleting content link:', error);
        showAlert('Error deleting content link', 'danger');
    }
}

// Reset form
function resetForm() {
    if (currentPlatformData) {
        populateForm(currentPlatformData);
    }
}

// Show alert message
function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const alertId = 'alert-' + Date.now();
    
    const alertDiv = document.createElement('div');
    alertDiv.id = alertId;
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    alertContainer.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}