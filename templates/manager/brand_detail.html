{% extends 'manager/base.html' %}

{% block page_title %}{{ brand.brand_name }}{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'manager:brand_quick_update' brand.id %}" class="btn btn-success">
        <i class="fas fa-chart-line me-2"></i>
        Quick Update
    </a>
    <a href="/admin/profiles/brandprofile/{{ brand.id }}/change/" class="btn btn-outline-secondary">
        <i class="fas fa-edit me-2"></i>
        Edit Profile
    </a>
    <a href="{% url 'manager:generate_brand_folder' brand.id %}" class="btn-primary-custom">
        <i class="fas fa-download me-2"></i>
        Download Folder Structure
    </a>
    <a href="{% url 'manager:dashboard' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>
        Back to Dashboard
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Brand Info Card -->
    <div class="col-md-4">
        <div class="brand-card">
            <h4 class="mb-3">Brand Information</h4>
            
            <div class="mb-3">
                <strong>Brand Name:</strong><br>
                <span class="text-muted">{{ brand.brand_name }}</span>
            </div>
            
            <div class="mb-3">
                <strong>Primary Contact:</strong><br>
                <span class="text-muted">{{ brand.primary_contact_first_name }} {{ brand.primary_contact_last_name }}</span><br>
                <small class="text-muted">{{ brand.primary_official_email }}</small><br>
                <small class="text-muted">{{ brand.primary_phone_number }}</small>
            </div>
            
            {% if brand.secondary_contact_first_name %}
            <div class="mb-3">
                <strong>Secondary Contact:</strong><br>
                <span class="text-muted">{{ brand.secondary_contact_first_name }} {{ brand.secondary_contact_last_name }}</span><br>
                <small class="text-muted">{{ brand.secondary_official_email }}</small><br>
                <small class="text-muted">{{ brand.secondary_phone_number }}</small>
            </div>
            {% endif %}
            
            <div class="mb-3">
                <strong>Website:</strong><br>
                {% if brand.brand_website %}
                <a href="{{ brand.brand_website }}" target="_blank" class="text-decoration-none">{{ brand.brand_website }}</a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <strong>Created:</strong><br>
                <span class="text-muted">{{ brand.created_at|date:"F j, Y" }}</span>
            </div>
        </div>
        
        <!-- Brand Vision/Mission -->
        <div class="brand-card mt-3">
            <h5 class="mb-3">Brand Identity</h5>
            
            {% if brand.brand_vision %}
            <div class="mb-3">
                <strong>Vision:</strong>
                <p class="text-muted small">{{ brand.brand_vision }}</p>
            </div>
            {% endif %}
            
            {% if brand.brand_mission %}
            <div class="mb-3">
                <strong>Mission:</strong>
                <p class="text-muted small">{{ brand.brand_mission }}</p>
            </div>
            {% endif %}
            
            {% if brand.brand_core_values %}
            <div class="mb-3">
                <strong>Core Values:</strong>
                <p class="text-muted small">{{ brand.brand_core_values }}</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Public Dashboard Section -->
        <div class="brand-card mt-3">
            <h5 class="mb-3">
                <i class="fas fa-share-alt me-2"></i>
                Public Dashboard
            </h5>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><strong>Public Access:</strong></span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="publicToggle" 
                               {% if brand.is_public_enabled %}checked{% endif %}
                               onchange="togglePublicAccess({{ brand.id }})">
                        <label class="form-check-label" for="publicToggle">
                            <span id="toggleLabel">{{ brand.is_public_enabled|yesno:"Enabled,Disabled" }}</span>
                        </label>
                    </div>
                </div>
                
                {% if brand.is_public_enabled and brand.public_uuid %}
                <div id="publicLinkSection" class="mt-3">
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="publicLinkInput" 
                               value="{{ request.scheme }}://{{ request.get_host }}{% url 'dashboard:public_dashboard' brand.public_uuid %}"
                               readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyPublicLink()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" onclick="openPublicDashboard()">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Preview
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="regenerateLink({{ brand.id }})">
                            <i class="fas fa-sync me-1"></i>
                            Regenerate Link
                        </button>
                    </div>
                </div>
                {% else %}
                <div id="publicLinkSection" style="display: none;">
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="publicLinkInput" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyPublicLink()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" onclick="openPublicDashboard()">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Preview
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="regenerateLink({{ brand.id }})">
                            <i class="fas fa-sync me-1"></i>
                            Regenerate Link
                        </button>
                    </div>
                </div>
                {% endif %}
                
                {% if brand.public_link_created_at %}
                <small class="text-muted">
                    Created by {{ brand.public_link_created_by.username }} on {{ brand.public_link_created_at|date:"M j, Y" }}
                </small>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Platform Progress -->
    <div class="col-md-8">
        <div class="brand-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Platform Progress</h4>
                <div class="d-flex gap-2">
                    <button onclick="bulkPlatformVisibility('show_all')" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-eye me-1"></i>
                        Show All
                    </button>
                    <button onclick="bulkPlatformVisibility('hide_inactive')" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-eye-slash me-1"></i>
                        Hide Inactive
                    </button>
                    <a href="/admin/dashboard/clientplatformprogress/add/?user={{ brand.user.id }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>
                        Add Platform
                    </a>
                </div>
            </div>
            
            {% if platforms %}
                <div class="row">
                    {% for platform in platforms %}
                    <div class="col-md-6 mb-3">
                        <div class="p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">{{ platform.get_platform_display }}</h6>
                                <div class="d-flex gap-2 align-items-center">
                                    <!-- Visibility Toggle -->
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="visibility_{{ platform.id }}" 
                                               {% if platform.is_visible %}checked{% endif %}
                                               onchange="togglePlatformVisibility({{ platform.id }})">
                                        <label class="form-check-label" for="visibility_{{ platform.id }}" title="Toggle Visibility">
                                            <i class="fas fa-eye{% if not platform.is_visible %}-slash{% endif %}" id="eye_{{ platform.id }}"></i>
                                        </label>
                                    </div>
                                    
                                    <!-- Active/Inactive Toggle -->
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="active_{{ platform.id }}" 
                                               {% if platform.is_active %}checked{% endif %}
                                               onchange="togglePlatformActive({{ platform.id }})">
                                        <label class="form-check-label" for="active_{{ platform.id }}" title="Toggle Active Status">
                                            <i class="fas fa-{% if platform.is_active %}play{% else %}pause{% endif %}" id="active_icon_{{ platform.id }}" style="color: {% if platform.is_active %}#28a745{% else %}#dc3545{% endif %}"></i>
                                        </label>
                                    </div>
                                    
                                    <!-- Status Badge -->
                                    <span class="badge {% if platform.is_active %}bg-success{% else %}bg-danger{% endif %}" id="status_badge_{{ platform.id }}">
                                        {% if platform.is_active %}ACTIVE{% else %}INACTIVE{% endif %}
                                    </span>
                                    
                                    <a href="/admin/dashboard/clientplatformprogress/{{ platform.id }}/change/" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </div>
                            
                            <div class="progress-stats mb-2">
                                <div class="stat">
                                    <small>Committed: <strong>{{ platform.committed }}</strong></small>
                                </div>
                                <div class="stat">
                                    <small>Drafted: <strong>{{ platform.drafted }}</strong></small>
                                </div>
                                <div class="stat">
                                    <small>Published: <strong>{{ platform.published }}</strong></small>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <div class="progress-bar-custom">
                                    <div class="progress-fill-custom" style="width: {{ platform.completion_percentage }}%;"></div>
                                </div>
                                <small class="text-muted">{{ platform.completion_percentage }}% complete</small>
                            </div>
                            
                            {% if platform.content_links.all %}
                            <div class="mt-2">
                                <small class="text-muted">Content Links:</small>
                                {% for link in platform.content_links.all %}
                                <div>
                                    <a href="{{ link.url }}" target="_blank" class="small text-decoration-none">
                                        <i class="fas fa-external-link-alt me-1"></i>{{ link.title }}
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-share-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No platforms configured</h5>
                    <p class="text-muted">Add platforms to start tracking content progress</p>
                    <a href="/admin/dashboard/clientplatformprogress/add/?user={{ brand.user.id }}" class="btn-primary-custom">
                        <i class="fas fa-plus me-2"></i>
                        Add First Platform
                    </a>
                </div>
            {% endif %}
        </div>
        
        <!-- Quick Actions -->
        <div class="brand-card mt-3">
            <h5 class="mb-3">Quick Actions</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="d-grid gap-2">
                        <a href="/admin/profiles/brandprofile/{{ brand.id }}/change/" class="btn btn-outline-primary">
                            <i class="fas fa-user-edit me-2"></i>
                            Edit Brand Profile
                        </a>
                        <a href="/admin/dashboard/clientplatformprogress/?user__id__exact={{ brand.user.id }}" class="btn btn-outline-success">
                            <i class="fas fa-chart-bar me-2"></i>
                            Manage All Platforms
                        </a>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-grid gap-2">
                        <a href="{% url 'manager:generate_brand_folder' brand.id %}" class="btn btn-outline-warning">
                            <i class="fas fa-folder-plus me-2"></i>
                            Generate Folder Structure
                        </a>
                        <a href="/dashboard/" class="btn btn-outline-info">
                            <i class="fas fa-eye me-2"></i>
                            Preview Client Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF Token for AJAX requests
function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) {
        return token.value;
    }
    // Fallback: get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

// Toggle public access
async function togglePublicAccess(brandId) {
    const toggle = document.getElementById('publicToggle');
    const label = document.getElementById('toggleLabel');
    const linkSection = document.getElementById('publicLinkSection');
    
    try {
        const response = await fetch(`/manager/brand/${brandId}/toggle-public-access/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            label.textContent = data.is_enabled ? 'Enabled' : 'Disabled';
            
            if (data.is_enabled) {
                if (data.public_uuid) {
                    // Generate the full public URL
                    const publicUrl = `${window.location.protocol}//${window.location.host}/dashboard/public/${data.public_uuid}/`;
                    document.getElementById('publicLinkInput').value = publicUrl;
                }
                linkSection.style.display = 'block';
            } else {
                linkSection.style.display = 'none';
            }
        } else {
            // Revert toggle on error
            toggle.checked = !toggle.checked;
            alert('Error updating public access');
        }
    } catch (error) {
        console.error('Error:', error);
        toggle.checked = !toggle.checked;
        alert('Error updating public access');
    }
}

// Generate public link
async function generatePublicLink(brandId) {
    try {
        const response = await fetch(`/manager/brand/${brandId}/generate-public-link/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('publicLinkInput').value = data.public_url;
            document.getElementById('publicLinkSection').style.display = 'block';
            document.getElementById('publicToggle').checked = true;
            document.getElementById('toggleLabel').textContent = 'Enabled';
        } else {
            alert('Error generating public link');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error generating public link');
    }
}

// Regenerate public link
async function regenerateLink(brandId) {
    if (!confirm('This will invalidate the old public link. Are you sure?')) {
        return;
    }
    
    try {
        const response = await fetch(`/manager/brand/${brandId}/regenerate-uuid/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('publicLinkInput').value = data.public_url;
            alert('Public link has been regenerated successfully!');
        } else {
            alert('Error regenerating public link');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error regenerating public link');
    }
}

// Copy public link to clipboard
async function copyPublicLink() {
    const input = document.getElementById('publicLinkInput');
    
    try {
        await navigator.clipboard.writeText(input.value);
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
        }, 2000);
        
    } catch (err) {
        // Fallback for older browsers
        input.select();
        document.execCommand('copy');
        alert('Public link copied to clipboard!');
    }
}

// Open public dashboard in new tab
function openPublicDashboard() {
    const url = document.getElementById('publicLinkInput').value;
    if (url) {
        window.open(url, '_blank');
    }
}

// Platform visibility toggle functions
function togglePlatformVisibility(platformId) {
    fetch(`/manager/platform/${platformId}/toggle-visibility/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the eye icon
            const eyeIcon = document.getElementById(`eye_${platformId}`);
            if (data.is_visible) {
                eyeIcon.className = 'fas fa-eye';
            } else {
                eyeIcon.className = 'fas fa-eye-slash';
            }
            
            // Show success message
            showMessage(`${data.platform_name} visibility updated`, 'success');
        } else {
            showMessage('Error updating visibility: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error updating visibility', 'error');
    });
}

function bulkPlatformVisibility(action) {
    fetch(`/manager/brand/{{ brand.id }}/bulk-platform-visibility/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to reflect changes
            window.location.reload();
        } else {
            showMessage('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error updating platform visibility', 'error');
    });
}

// Platform active toggle function
function togglePlatformActive(platformId) {
    fetch(`/manager/platform/${platformId}/toggle-active/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the active icon
            const activeIcon = document.getElementById(`active_icon_${platformId}`);
            const statusBadge = document.getElementById(`status_badge_${platformId}`);
            
            if (data.is_active) {
                activeIcon.className = 'fas fa-play';
                activeIcon.style.color = '#28a745';
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'ACTIVE';
            } else {
                activeIcon.className = 'fas fa-pause';
                activeIcon.style.color = '#dc3545';
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'INACTIVE';
            }
            
            // Show success message
            showMessage(`${data.platform_name} status updated to ${data.is_active ? 'ACTIVE' : 'INACTIVE'}`, 'success');
        } else {
            showMessage('Error updating active status: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error updating active status', 'error');
    });
}

</script>


{% endblock %}